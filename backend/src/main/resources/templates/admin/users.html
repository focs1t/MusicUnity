<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head">
</head>
<body>
    <div th:replace="fragments/header :: nav"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 th:text="${title}">Управление пользователями</h1>
        </div>

        <!-- Фильтры -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/admin/users}" method="get" class="row g-3" id="filterForm">
                    <div class="col-md-3">
                        <label for="role" class="form-label">Роль</label>
                        <select class="form-select" id="role" name="role" onchange="submitForm()">
                            <option value="">Все роли</option>
                            <option value="USER" th:selected="${currentRole == T(ru.musicunity.backend.pojo.enums.UserRole).USER}">Пользователь</option>
                            <option value="AUTHOR" th:selected="${currentRole == T(ru.musicunity.backend.pojo.enums.UserRole).AUTHOR}">Автор</option>
                            <option value="MODERATOR" th:selected="${currentRole == T(ru.musicunity.backend.pojo.enums.UserRole).MODERATOR}">Модератор</option>
                            <option value="ADMIN" th:selected="${currentRole == T(ru.musicunity.backend.pojo.enums.UserRole).ADMIN}">Администратор</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">Статус</label>
                        <select class="form-select" id="status" name="status" onchange="submitForm()">
                            <option value="">Все статусы</option>
                            <option value="active" th:selected="${currentStatus == 'active'}">Активные</option>
                            <option value="blocked" th:selected="${currentStatus == 'blocked'}">Заблокированные</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="search" class="form-label">Поиск</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Поиск по имени или email" th:value="${currentSearch}"
                               oninput="debounceSubmit()">
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div id="usersTable">
                    <div class="alert alert-info" th:if="${users.empty}">
                        <i class="bi bi-info-circle"></i> Пользователи не найдены.
                    </div>
                    <div class="table-responsive" th:unless="${users.empty}">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="id">
                                        ID
                                        <span th:if="${currentSort == 'id'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th class="sortable" data-sort="username">
                                        Имя пользователя
                                        <span th:if="${currentSort == 'username'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th class="sortable" data-sort="email">
                                        Email
                                        <span th:if="${currentSort == 'email'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th class="sortable" data-sort="role">
                                        Роль
                                        <span th:if="${currentSort == 'role'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th class="sortable" data-sort="createdAt">
                                        Дата регистрации
                                        <span th:if="${currentSort == 'createdAt'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th class="sortable" data-sort="lastLogin">
                                        Последний вход
                                        <span th:if="${currentSort == 'lastLogin'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th class="sortable" data-sort="status">
                                        Статус
                                        <span th:if="${currentSort == 'status'}" th:text="${currentDirection == 'asc' ? '↑' : '↓'}"></span>
                                    </th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="user : ${users}">
                                    <td th:text="${user.userId}">1</td>
                                    <td th:text="${user.username}">username</td>
                                    <td th:text="${user.email}">email@example.com</td>
                                    <td>
                                        <span class="badge" th:classappend="${user.rights == T(ru.musicunity.backend.pojo.enums.UserRole).ADMIN ? 'bg-danger' : 
                                                                            (user.rights == T(ru.musicunity.backend.pojo.enums.UserRole).MODERATOR ? 'bg-warning' : 
                                                                            (user.rights == T(ru.musicunity.backend.pojo.enums.UserRole).AUTHOR ? 'bg-success' : 'bg-primary'))}"
                                              th:text="${user.rights}">USER</span>
                                    </td>
                                    <td th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 12:00</td>
                                    <td th:text="${user.lastLogin != null ? #temporals.format(user.lastLogin, 'dd.MM.yyyy HH:mm') : 'Давно'}">01.01.2024 12:00</td>
                                    <td>
                                        <span class="badge" th:classappend="${user.isBlocked ? 'bg-danger' : 'bg-success'}"
                                              th:text="${user.isBlocked ? 'Заблокирован' : 'Активен'}">Активен</span>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    data-bs-toggle="modal" 
                                                    th:data-bs-target="'#userModal' + ${user.userId}">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#changeRoleModal" 
                                                    th:data-user-id="${user.userId}"
                                                    th:data-username="${user.username}"
                                                    th:data-current-role="${user.rights}">
                                                <i class="bi bi-shield-lock"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#linkAuthorModal" 
                                                    th:data-user-id="${user.userId}"
                                                    th:data-username="${user.username}">
                                                <i class="bi bi-person-plus"></i>
                                            </button>
                                            <form th:if="${!user.isBlocked}" th:action="@{/admin/users/{id}/ban(id=${user.userId})}" method="post" class="d-inline">
                                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Заблокировать пользователя?')">
                                                    <i class="bi bi-lock"></i>
                                                </button>
                                            </form>
                                            <form th:if="${user.isBlocked}" th:action="@{/admin/users/{id}/unban(id=${user.userId})}" method="post" class="d-inline">
                                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                                <button type="submit" class="btn btn-sm btn-outline-success" onclick="return confirm('Разблокировать пользователя?')">
                                                    <i class="bi bi-unlock"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <nav th:if="${users.totalPages > 1}">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${users.first ? 'disabled' : ''}">
                                <a class="page-link" th:href="@{/admin/users(page=${users.number - 1})}">Предыдущая</a>
                            </li>
                            <li class="page-item" th:each="i : ${#numbers.sequence(0, users.totalPages - 1)}"
                                th:classappend="${i == users.number ? 'active' : ''}">
                                <a class="page-link" th:href="@{/admin/users(page=${i})}" th:text="${i + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${users.last ? 'disabled' : ''}">
                                <a class="page-link" th:href="@{/admin/users(page=${users.number + 1})}">Следующая</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальные окна для каждого пользователя -->
    <div th:each="user : ${users}" th:id="'userModal' + ${user.userId}" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Информация о пользователе</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <img th:if="${user.avatarUrl}" th:src="${user.avatarUrl}" class="img-thumbnail rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
                        <div th:unless="${user.avatarUrl}" class="bg-secondary text-white d-flex align-items-center justify-content-center mx-auto rounded-circle" style="width: 100px; height: 100px;">
                            <i class="bi bi-person" style="font-size: 3rem;"></i>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ID:</strong> <span th:text="${user.userId}"></span></p>
                            <p><strong>Имя пользователя:</strong> <span th:text="${user.username}"></span></p>
                            <p><strong>Email:</strong> <span th:text="${user.email}"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Роль:</strong> <span th:text="${user.rights}"></span></p>
                            <p><strong>Статус:</strong> <span th:text="${user.isBlocked ? 'Заблокирован' : 'Активен'}"></span></p>
                            <p><strong>Дата регистрации:</strong> <span th:text="${#temporals.format(user.createdAt, 'dd.MM.yyyy HH:mm')}"></span></p>
                        </div>
                    </div>
                    <div th:if="${user.rights == T(ru.musicunity.backend.pojo.enums.UserRole).AUTHOR}" class="mt-3">
                        <hr>
                        <h6>Информация об авторе:</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <span th:if="${user.linkedAuthor != null}">
                                Привязан к автору: <strong th:text="${user.linkedAuthor.authorName}">Имя автора</strong>
                                <span class="badge bg-success ms-2" th:if="${user.linkedAuthor.isVerified}">Верифицирован</span>
                            </span>
                            <span th:unless="${user.linkedAuthor != null}">
                                <strong class="text-warning">Автор не привязан</strong>
                            </span>
                            <form th:action="@{/admin/users/{id}/unlink-author(id=${user.userId})}" method="post" class="d-inline">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                        onclick="return confirm('Отвязать пользователя от автора? Роль будет изменена на USER.')">
                                    Отвязать от автора
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно изменения роли -->
    <div class="modal fade" id="changeRoleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Изменение роли пользователя <span id="modalUsername"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changeRoleForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="mb-3">
                            <label for="role" class="form-label">Роль</label>
                            <select class="form-select" id="role" name="role" required>
                                <option value="USER">Пользователь</option>
                                <option value="AUTHOR">Автор</option>
                                <option value="MODERATOR">Модератор</option>
                                <option value="ADMIN">Администратор</option>
                            </select>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="submit" class="btn btn-primary">Сохранить</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно привязки к автору -->
    <div class="modal fade" id="linkAuthorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Привязать пользователя <span id="linkAuthorUsername"></span> к автору</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="linkAuthorForm" method="post">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="mb-3">
                            <label for="authorId" class="form-label">Выберите автора</label>
                            <select class="form-select" id="authorId" name="authorId" required>
                                <option value="">-- Выберите автора --</option>
                                <option th:each="author : ${allAuthors.content}" 
                                        th:value="${author.authorId}" 
                                        th:text="${author.authorName} + ' (ID: ' + ${author.authorId} + ')'">
                                </option>
                            </select>
                        </div>
                        <div class="alert alert-info">
                            <strong>Внимание:</strong> При привязке пользователю будет автоматически присвоена роль "Автор", а сам автор будет верифицирован.
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                            <button type="submit" class="btn btn-primary">Привязать</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
    .sortable {
        cursor: pointer;
        position: relative;
        padding-right: 20px;
    }

    .sortable:hover {
        background-color: #f8f9fa;
    }

    .sortable span {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
    }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let searchTimeout;
        let currentSort = /*[[${currentSort}]]*/ null;
        let currentDirection = /*[[${currentDirection}]]*/ 'asc';
        
        function debounceSubmit() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(submitForm, 300);
        }

        function handleSort(sortField) {
            if (currentSort === sortField) {
                currentDirection = currentDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort = sortField;
                currentDirection = 'asc';
            }
            
            submitForm();
        }

        function submitForm() {
            const form = document.getElementById('filterForm');
            const formData = new FormData(form);
            
            // Добавляем параметры сортировки
            if (currentSort) {
                formData.append('sort', currentSort);
                formData.append('direction', currentDirection);
            }
            
            const queryString = new URLSearchParams(formData).toString();
            const url = `${window.location.pathname}?${queryString}`;
            
            // Обновляем URL без перезагрузки страницы
            window.history.pushState({}, '', url);
            
            // Отправляем AJAX-запрос
            fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('usersTable').innerHTML = html;
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        handleSort(header.dataset.sort);
                    });
                });
            });
        }

        // Инициализация обработчиков событий при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    handleSort(header.dataset.sort);
                });
            });
            
            // Обработчик для модального окна изменения роли
            const changeRoleModal = document.getElementById('changeRoleModal');
            if (changeRoleModal) {
                changeRoleModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const userId = button.getAttribute('data-user-id');
                    const username = button.getAttribute('data-username');
                    const currentRole = button.getAttribute('data-current-role');
                    
                    const modalTitle = changeRoleModal.querySelector('#modalUsername');
                    const form = changeRoleModal.querySelector('#changeRoleForm');
                    const roleSelect = changeRoleModal.querySelector('#role');
                    
                    modalTitle.textContent = username;
                    form.action = `/admin/users/${userId}/role`;
                    roleSelect.value = currentRole;
                });
            }
            
            // Обработчик для модального окна привязки к автору
            const linkAuthorModal = document.getElementById('linkAuthorModal');
            if (linkAuthorModal) {
                linkAuthorModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const userId = button.getAttribute('data-user-id');
                    const username = button.getAttribute('data-username');
                    
                    const modalTitle = linkAuthorModal.querySelector('#linkAuthorUsername');
                    const form = linkAuthorModal.querySelector('#linkAuthorForm');
                    
                    modalTitle.textContent = username;
                    form.action = `/admin/users/${userId}/link-author`;
                });
            }
        });

        // Обработчик модального окна изменения роли
        document.getElementById('changeRoleModal').addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userId = button.getAttribute('data-user-id');
            const username = button.getAttribute('data-username');
            const currentRole = button.getAttribute('data-current-role');
            
            document.getElementById('modalUsername').textContent = username;
            this.querySelector('#role').value = currentRole;
            this.querySelector('#changeRoleForm').action = `/admin/users/${userId}/role`;
        });

        // Показ уведомлений
        const successMessage = document.querySelector('.alert-success');
        if (successMessage) {
            setTimeout(() => {
                successMessage.style.opacity = '0';
                setTimeout(() => successMessage.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html> 