<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление релизами - MusicUnity Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sortable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .release-cover {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-music me-2"></i>MusicUnity Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin">Главная</a>
                <a class="nav-link" href="/admin/genres">Жанры</a>
                <a class="nav-link" href="/admin/authors">Авторы</a>
                <a class="nav-link active" href="/admin/releases">Релизы</a>
                <a class="nav-link" href="/admin/users">Пользователи</a>
                <a class="nav-link" href="/admin/reviews">Рецензии</a>
                <a class="nav-link" href="/admin/registration-requests">Заявки</a>
                <a class="nav-link" href="/admin/audit">Аудит</a>
                <a class="nav-link" href="/logout">Выход</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="fas fa-compact-disc me-2"></i>Управление релизами</h2>
                <p class="text-muted">Управление музыкальными релизами системы</p>
            </div>
            <div class="col-md-4 text-end">
                <a href="/admin" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Назад
                </a>
            </div>
        </div>

        <!-- Фильтры -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/admin/releases}" method="get" class="row g-3" id="filterForm">
                    <div class="col-md-3">
                        <label for="releaseType" class="form-label">Тип релиза</label>
                        <select class="form-select" id="releaseType" name="releaseType" onchange="submitForm()">
                            <option value="">Все типы</option>
                            <option th:each="type : ${T(ru.musicunity.backend.pojo.enums.ReleaseType).values()}" 
                                    th:value="${type}" th:text="${type}" th:selected="${releaseType == type.toString()}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="year" class="form-label">Год</label>
                        <select class="form-select" id="year" name="year" onchange="submitForm()">
                            <option value="">Все годы</option>
                            <option th:each="y : ${#numbers.sequence(2024, 2000)}" th:value="${y}" th:text="${y}" 
                                    th:selected="${year != null && year == y}"></option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="showDeleted" class="form-label">Статус</label>
                        <select class="form-select" id="showDeleted" name="showDeleted" onchange="submitForm()">
                            <option value="false" th:selected="${!showDeleted}">Активные</option>
                            <option value="true" th:selected="${showDeleted}">Удаленные</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <label for="search" class="form-label">Поиск</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               placeholder="Поиск по названию, автору или жанру" th:value="${search}"
                               oninput="debounceSubmit()">
                    </div>
                </form>
            </div>
        </div>

        <!-- Список релизов -->
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Релизы
                    <span th:if="${showDeleted}" class="badge bg-danger ms-2">Удаленные</span>
                </h5>
            </div>
            <div class="card-body">
                <div th:if="${releases.empty}" class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>Нет релизов</p>
                </div>
                
                <div th:unless="${releases.empty}">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>Обложка</th>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Автор(ы)</th>
                                    <th>Жанр(ы)</th>
                                    <th>Тип</th>
                                    <th>Дата релиза</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="release : ${releases.content}">
                                    <td>
                                        <img th:if="${release.coverUrl != null && !release.coverUrl.isEmpty()}"
                                             th:src="${release.coverUrl}" 
                                             class="release-cover" 
                                             alt="Обложка">
                                        <div th:unless="${release.coverUrl != null && !release.coverUrl.isEmpty()}"
                                             class="release-cover bg-secondary d-flex align-items-center justify-content-center">
                                            <i class="fas fa-music text-white"></i>
                                        </div>
                                    </td>
                                    <td th:text="${release.releaseId}">1</td>
                                    <td>
                                        <div>
                                            <strong th:text="${release.title}">Название релиза</strong>
                                            <a th:if="${release.releaseLink != null && !release.releaseLink.isEmpty()}"
                                               th:href="${release.releaseLink}" target="_blank" class="ms-2">
                                                <i class="fas fa-external-link-alt text-primary"></i>
                                            </a>
                                        </div>
                                    </td>
                                    <td>
                                        <div th:if="${release.authors != null && !release.authors.empty}">
                                            <span th:each="author, iterStat : ${release.authors}" 
                                                  th:text="${author.authorName + (iterStat.last ? '' : ', ')}"></span>
                                        </div>
                                        <span th:unless="${release.authors != null && !release.authors.empty}" class="text-muted">Неизвестно</span>
                                    </td>
                                    <td>
                                        <div th:if="${release.genres != null && !release.genres.empty}">
                                            <span th:each="genre, iterStat : ${release.genres}" 
                                                  th:text="${genre.name + (iterStat.last ? '' : ', ')}"></span>
                                        </div>
                                        <span th:unless="${release.genres != null && !release.genres.empty}" class="text-muted">Неизвестно</span>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${release.type?.name() == 'ALBUM'} ? 'bg-primary' : 
                                                              (${release.type?.name() == 'SINGLE'} ? 'bg-success' : 
                                                              (${release.type?.name() == 'EP'} ? 'bg-info' : 'bg-secondary'))"
                                              th:text="${release.type}">TYPE</span>
                                    </td>
                                    <td th:text="${release.releaseDate}">2024-01-01</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <!-- Кнопка деталей -->
                                            <button type="button" 
                                                    class="btn btn-outline-info btn-sm release-details-btn"
                                                    th:data-release-id="${release.releaseId}"
                                                    data-bs-toggle="tooltip" 
                                                    data-bs-placement="top" 
                                                    title="Просмотр деталей релиза">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            

                                            
                                            <!-- Кнопка мягкого удаления (только для активных) -->
                                            <button type="button" 
                                                    th:unless="${showDeleted}"
                                                    class="btn btn-outline-danger btn-sm soft-delete-release-btn"
                                                    th:data-release-id="${release.releaseId}"
                                                    th:data-title="${release.title}"
                                                    data-bs-toggle="tooltip" 
                                                    data-bs-placement="top" 
                                                    title="Пометить как удаленный">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            
                                            <!-- Кнопки для удаленных релизов -->
                                            <div th:if="${showDeleted}" class="btn-group btn-group-sm">
                                                <button type="button" 
                                                        class="btn btn-outline-success btn-sm restore-release-btn"
                                                        th:data-release-id="${release.releaseId}"
                                                        th:data-title="${release.title}"
                                                        data-bs-toggle="tooltip" 
                                                        data-bs-placement="top" 
                                                        title="Восстановить релиз">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                                
                                                <button type="button" 
                                                        class="btn btn-outline-danger btn-sm hard-delete-release-btn"
                                                        th:data-release-id="${release.releaseId}"
                                                        th:data-title="${release.title}"
                                                        data-bs-toggle="tooltip" 
                                                        data-bs-placement="top" 
                                                        title="Удалить безвозвратно">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Пагинация -->
                    <nav th:if="${releases.totalPages > 1}">
                        <ul class="pagination justify-content-center">
                            <li class="page-item" th:classappend="${releases.first} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/releases(page=${releases.number - 1})}">Предыдущая</a>
                            </li>
                            <li class="page-item" 
                                th:each="page : ${#numbers.sequence(0, releases.totalPages - 1)}"
                                th:classappend="${page == releases.number} ? 'active'">
                                <a class="page-link" th:href="@{/admin/releases(page=${page})}" th:text="${page + 1}">1</a>
                            </li>
                            <li class="page-item" th:classappend="${releases.last} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/releases(page=${releases.number + 1})}">Следующая</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно деталей релиза -->
    <div class="modal fade" id="releaseDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Детали релиза</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="releaseDetailsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let debounceTimer;
        
        function debounceSubmit() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                document.getElementById('filterForm').submit();
            }, 500);
        }
        
        function submitForm() {
            document.getElementById('filterForm').submit();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Обработчики для кнопок деталей
            document.querySelectorAll('.release-details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const releaseId = this.dataset.releaseId;
                    showReleaseDetails(releaseId);
                });
            });
            
            // Обработчики для кнопок редактирования
            document.querySelectorAll('.edit-release-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const releaseId = this.dataset.releaseId;
                    const title = this.dataset.title;
                    const coverUrl = this.dataset.coverUrl;
                    const releaseLink = this.dataset.releaseLink;
                    showEditReleaseModal(releaseId, title, coverUrl, releaseLink);
                });
            });
            
            // Обработчики для кнопок мягкого удаления
            document.querySelectorAll('.soft-delete-release-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const releaseId = this.dataset.releaseId;
                    const title = this.dataset.title;
                    softDeleteRelease(releaseId, title);
                });
            });
            
            // Обработчики для кнопок восстановления
            document.querySelectorAll('.restore-release-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const releaseId = this.dataset.releaseId;
                    const title = this.dataset.title;
                    restoreRelease(releaseId, title);
                });
            });
            
            // Обработчики для кнопок жесткого удаления
            document.querySelectorAll('.hard-delete-release-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const releaseId = this.dataset.releaseId;
                    const title = this.dataset.title;
                    hardDeleteRelease(releaseId, title);
                });
            });
            

        });
        
        function showReleaseDetails(releaseId) {
            const modal = new bootstrap.Modal(document.getElementById('releaseDetailsModal'));
            const content = document.getElementById('releaseDetailsContent');
            
            // Показываем спиннер
            content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            `;
            
            modal.show();
            
            // Загружаем данные релиза
            fetch('/api/releases/' + releaseId)
                .then(response => response.json())
                .then(release => {
                    content.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                ${release.coverUrl ? 
                                    `<img src="${release.coverUrl}" class="img-fluid rounded" alt="Обложка">` :
                                    `<div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 200px; border-radius: 8px;">
                                        <i class="fas fa-music fa-3x"></i>
                                    </div>`
                                }
                            </div>
                            <div class="col-md-8">
                                <h6>Основная информация</h6>
                                <p><strong>ID:</strong> ${release.releaseId}</p>
                                <p><strong>Название:</strong> ${release.title}</p>
                                <p><strong>Тип:</strong> ${release.type}</p>
                                <p><strong>Дата релиза:</strong> ${new Date(release.releaseDate).toLocaleDateString('ru-RU')}</p>

                                ${release.releaseLink ? `<p><strong>Ссылка:</strong> <a href="${release.releaseLink}" target="_blank">Открыть</a></p>` : ''}
                                
                                <h6>Авторы</h6>
                                ${release.authors && release.authors.length > 0 ? 
                                    release.authors.map(author => `<span class="badge bg-primary me-1">${author.authorName}</span>`).join('') :
                                    '<span class="text-muted">Неизвестно</span>'
                                }
                                
                                <h6 class="mt-3">Жанры</h6>
                                ${release.genres && release.genres.length > 0 ? 
                                    release.genres.map(genre => `<span class="badge bg-secondary me-1">${genre.name}</span>`).join('') :
                                    '<span class="text-muted">Неизвестно</span>'
                                }
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Ошибка загрузки данных релиза
                        </div>
                    `;
                });
        }
        

        
        function softDeleteRelease(releaseId, title) {
            if (confirm('Вы уверены, что хотите пометить релиз "' + title + '" как удаленный?')) {
                fetch('/admin/releases/' + releaseId + '/soft-delete', {
                    method: 'POST'
                }).then(response => response.text()).then(message => {
                    alert(message);
                    location.reload();
                }).catch(error => {
                    alert('Ошибка при удалении релиза');
                });
            }
        }
        
        function restoreRelease(releaseId, title) {
            if (confirm('Вы уверены, что хотите восстановить релиз "' + title + '"?')) {
                fetch('/admin/releases/' + releaseId + '/restore', {
                    method: 'POST'
                }).then(response => response.text()).then(message => {
                    alert(message);
                    location.reload();
                }).catch(error => {
                    alert('Ошибка при восстановлении релиза');
                });
            }
        }
        
        function hardDeleteRelease(releaseId, title) {
            if (confirm('ВНИМАНИЕ! Вы уверены, что хотите БЕЗВОЗВРАТНО удалить релиз "' + title + '"? Это действие нельзя отменить!')) {
                fetch('/admin/releases/' + releaseId + '/hard-delete', {
                    method: 'POST'
                }).then(response => response.text()).then(message => {
                    alert(message);
                    location.reload();
                }).catch(error => {
                    alert('Ошибка при удалении релиза');
                });
            }
        }
    </script>
</body>
</html> 